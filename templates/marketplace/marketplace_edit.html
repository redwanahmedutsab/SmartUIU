{% load static %}
<!DOCTYPE html>
<html lang="en">
<!-- Include Head -->
{% include 'expendable/head.html' %}

<body>
<!-- Include Navbar -->
{% include 'expendable/navbar.html' %}

<!-- jQuery, Popper.js, and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Hero Section with Parallax Effect -->
<section class="section-hero overlay inner-page bg-image"
         style="background-image: url('{% static "images/hero_1.jpg" %}'); background-attachment: fixed;"
         id="home-section">
    <div class="container">
        <div class="row align-items-center justify-content-center text-center">
            <div class="col-md-8">
                <h1 class="text-white display-4 font-weight-bold">Edit Product</h1>
                <div class="custom-breadcrumbs">
                    <a href="{% url 'homepage' %}">Home</a> <span class="mx-2 slash">/</span>
                    <a href="{% url 'marketplace' %}">Products</a> <span class="mx-2 slash">/</span>
                    <span class="text-white"><strong>Edit {{ product.name }}</strong></span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Container for Form -->
<div class="container my-5">
    <div class="row">
        <!-- Product Image Preview with Delete Button -->
        <div class="col-md-6 mb-4">
            <h4>Product Images</h4>
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Image</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                {% if product.images.all %}
                    {% for image in product.images.all %}
                        <tr id="image-row-{{ image.id }}">
                            <td>
                                <img src="{{ image.image.url }}" class="img-fluid"
                                     style="max-height: 150px; object-fit: cover;">
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm"
                                        onclick="deleteImage('{{ image.id }}')">Delete
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2">No images available.</td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
            <!-- Image Upload Form -->
        </div>

        <!-- Form Section for Product Details -->
        <div class="col-md-6">
            <form id="product-edit-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Image Upload -->
                <div class="form-group">
                    <label for="new_images">Upload New Images</label>
                    <input type="file" id="new_images" name="new_images" class="form-control" multiple>
                </div>

                <!-- Product Details -->
                <div class="form-group">
                    <label for="name">Product Name</label>
                    <input type="text" id="name" name="name" class="form-control" value="{{ product.name }}" required>
                </div>
<div class="form-group">
    <label for="description">Description</label>
    <textarea id="description" name="description" class="form-control" rows="4" required>{{ product.description }}</textarea>
</div>

<!-- Include CKEditor -->
<script>
    CKEDITOR.replace('description'); // Replace the textarea with CKEditor
</script>
                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="number" id="price" name="price" class="form-control" value="{{ product.price }}"
                           step="0.01" required>
                </div>
                <div class="form-group mb-4">
                    <label for="product-category" class="h5 font-weight-bold">Product Category</label>
                    <select class="form-control form-control-lg border-0 shadow-sm rounded" name="category"
                            id="product-category" required>
                        <option value="" disabled {% if not product.category %}selected{% endif %}>Select Category
                        </option> <!-- Default option -->
                        <option value="Electronics" {% if product.category == "Electronics" %}selected{% endif %}>
                            Electronics
                        </option>
                        <option value="Clothing" {% if product.category == "Clothing" %}selected{% endif %}>Clothing
                        </option>
                        <option value="Home & Garden" {% if product.category == "Home & Garden" %}selected{% endif %}>
                            Home & Garden
                        </option>
                        <option value="Sports" {% if product.category == "Sports" %}selected{% endif %}>Sports</option>
                        <option value="Automotive" {% if product.category == "Automotive" %}selected{% endif %}>
                            Automotive
                        </option>
                        <option value="Other" {% if product.category == "Other" %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <div class="form-group">
    <label for="phone">Phone</label>
    <input type="text" id="phone" name="phone" class="form-control" value="{{ product.phone }}"
           required pattern="^(01[0-9]{9}|[0-9]{11})$"
           title="Phone number must start with '01' and be followed by 9 digits, or it must be exactly 11 digits."
           maxlength="11" oninput="validatePhone(this)">
</div>

<script>
    function validatePhone(input) {
        const regex = /^(01[0-9]{9}|[0-9]{11})$/;
        if (!regex.test(input.value)) {
            input.setCustomValidity("Phone number must start with '01' followed by 9 digits, or must be exactly 11 digits.");
        } else {
            input.setCustomValidity("");
        }
    }
</script>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" class="form-control" value="{{ product.location }}"
                           required>
                </div>
                <div class="form-group mb-4">
                    <label for="product-condition" class="h5 font-weight-bold">Condition</label>
                    <select class="form-control form-control-lg border-0 shadow-sm rounded" name="condition"
                            id="product-condition" required>
                        <option value="" disabled {% if not product.condition %}selected{% endif %}>Select Condition
                        </option> <!-- Default option -->
                        <option value="New" {% if product.condition == "New" %}selected{% endif %}>New</option>
                        <option value="Used" {% if product.condition == "Used" %}selected{% endif %}>Used</option>
                        <option value="Refurbished" {% if product.condition == "Refurbished" %}selected{% endif %}>
                            Refurbished
                        </option>
                    </select>
                </div>
                <div class="form-group mb-4">
                    <label for="shipping-details" class="h5 font-weight-bold">Shipping Method</label>
                    <select class="form-control form-control-lg border-0 shadow-sm rounded" name="shipping_details"
                            id="shipping-details" required>
                        <option value="" disabled {% if not product.shipping_details %}selected{% endif %}>Select
                            Shipping Method
                        </option>
                        <option value="Meetup" {% if product.shipping_details == "Meetup" %}selected{% endif %}>Meetup
                        </option>
                        <option value="Delivery" {% if product.shipping_details == "Delivery" %}selected{% endif %}>
                            Delivery
                        </option>
                        <option value="Home Pick Up"
                                {% if product.shipping_details == "Home Pick Up" %}selected{% endif %}>Home Pick Up
                        </option>
                    </select>
                </div>
                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary btn-lg">Update Product</button>
                <a href="{% url 'marketplace_my_post' %}" class="btn btn-secondary btn-lg ml-2">Cancel</a>
            </form>
        </div>
    </div>
</div>

<!-- Include Footer -->
{% include 'expendable/footer.html' %}

<script>
    function deleteImage(imageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            $.ajax({
                url: '{% url "delete_product_image" %}',
                method: 'POST',
                data: {
                    'image_id': imageId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        // Remove image row from the table
                        document.getElementById('image-row-' + imageId).remove();
                    } else {
                        alert('Error deleting image.');
                    }
                },
                error: function () {
                    alert('Error deleting image.');
                }
            });
        }
    }
</script>
</body>
</html>
